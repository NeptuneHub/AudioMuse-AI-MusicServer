name: Go Tests

on:
  push:
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        # Use Go 1.25 to match module's go directive (go 1.25.5)
        go-version: '1.25.5'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y pkg-config libsqlite3-dev build-essential

    - name: Debug workspace and Go environment
      run: |
        echo "PWD:" && pwd
        echo "Workspace files:" && ls -la
        echo "music-server-backend files:" && ls -la music-server-backend || true
        echo "cat go.mod (top-level):" && sed -n '1,80p' go.mod || true
        echo "cat go.mod (music-server-backend):" && sed -n '1,80p' music-server-backend/go.mod || true
        echo "go version:" && go version || true

    - name: Check module file inside working dir
      working-directory: music-server-backend
      run: |
        echo "PWD in step:" && pwd
        echo "Absolute path:" && readlink -f .
        echo "List files:" && ls -la
        echo "Show go.mod:" && sed -n '1,160p' go.mod || true

    - name: Run backend tests
      working-directory: music-server-backend
      env:
        CGO_ENABLED: '1'
        GO111MODULE: 'on'
      run: |
        echo "go env (in music-server-backend):" && go env
        # If the module files are missing (gitignored), create them like the Dockerfile does
        if [ ! -f go.mod ]; then
          echo "go.mod missing â€” initializing module and tidying dependencies"
          go mod init music-server-backend || true
          go mod tidy
        else
          # Otherwise download modules normally
          go mod download
        fi
        # Run tests
        go test ./... -v
